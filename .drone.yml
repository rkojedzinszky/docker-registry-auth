---
kind: pipeline
name: integration tests
services:
- environment:
    POSTGRES_PASSWORD: dra
    POSTGRES_USER: dra
  image: postgres:11
  name: postgres
steps:
- commands:
  - apk add --no-cache python3 py3-pip openssl supervisor nginx py3-psycopg2 uwsgi-python3
    py3-cryptography py3-jwt
  - pip3 install -r requirements.txt
  - DBHOST=127.0.0.1 python3 manage.py test
  image: alpine:3.14
  name: integration tests
  pull: always
trigger:
  branch:
  - master
type: kubernetes
---
### Autogenerated pipeline! DONT edit! ###
depends_on:
- integration tests
kind: pipeline
name: build-arm64
node_selector:
  kubernetes.io/arch: arm64
platform:
  arch: arm64
  os: linux
  variant: v8
resources:
  requests:
    memory: 128Mi
steps:
- image: plugins/docker
  name: image
  privileged: true
  pull: always
  settings:
    auto_label: false
    auto_tag: true
    auto_tag_suffix: arm64
    mirror:
      from_secret: hub_docker_mirror
    password:
      from_secret: ghcr.io.password
    registry: ghcr.io
    repo: ghcr.io/rkojedzinszky/docker-registry-auth
    username: rkojedzinszky
  volumes:
  - name: docker
    path: /var/lib/docker
type: kubernetes
volumes:
- name: docker
  temp: {}
---
### Autogenerated pipeline! DONT edit! ###
depends_on:
- integration tests
kind: pipeline
name: build-arm
node_selector:
  kubernetes.io/arch: arm
platform:
  arch: arm
  os: linux
  variant: v7
resources:
  requests:
    memory: 128Mi
steps:
- image: plugins/docker
  name: image
  privileged: true
  pull: always
  settings:
    auto_label: false
    auto_tag: true
    auto_tag_suffix: arm
    mirror:
      from_secret: hub_docker_mirror
    password:
      from_secret: ghcr.io.password
    registry: ghcr.io
    repo: ghcr.io/rkojedzinszky/docker-registry-auth
    username: rkojedzinszky
  volumes:
  - name: docker
    path: /var/lib/docker
type: kubernetes
volumes:
- name: docker
  temp: {}
---
### Autogenerated pipeline! DONT edit! ###
depends_on:
- integration tests
kind: pipeline
name: build-amd64
node_selector:
  kubernetes.io/arch: amd64
platform:
  arch: amd64
  os: linux
resources:
  requests:
    memory: 128Mi
steps:
- image: plugins/docker
  name: image
  privileged: true
  pull: always
  settings:
    auto_label: false
    auto_tag: true
    auto_tag_suffix: amd64
    mirror:
      from_secret: hub_docker_mirror
    password:
      from_secret: ghcr.io.password
    registry: ghcr.io
    repo: ghcr.io/rkojedzinszky/docker-registry-auth
    username: rkojedzinszky
  volumes:
  - name: docker
    path: /var/lib/docker
type: kubernetes
volumes:
- name: docker
  temp: {}
---
depends_on:
- build-arm64
- build-arm
- build-amd64
kind: pipeline
name: manifest
platform:
  arch: arm64
  os: linux
  variant: v8
steps:
- image: plugins/manifest
  name: ghcr.io/rkojedzinszky/docker-registry-auth
  pull: always
  settings:
    auto_tag: true
    password:
      from_secret: ghcr.io.password
    spec: manifests/ghcr.io-rkojedzinszky-docker-registry-auth.tmpl
    username: rkojedzinszky
type: kubernetes
